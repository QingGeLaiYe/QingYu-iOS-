name: iOS Demo Build

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  # æ¨¡æ‹Ÿå™¨æ„å»º - å®Œå…¨å…è´¹
  build-for-simulator:
    runs-on: macos-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '15.0'

    - name: Show Xcode version
      run: xcodebuild -version

    - name: Show available simulators
      run: xcrun simctl list devices available

    - name: Create project structure info
      run: |
        echo "ğŸ“ QingYu iOS Project Structure:"
        find . -type f -name "*.swift" | head -20
        echo ""
        echo "ğŸ”§ Xcode Project Info:"
        ls -la QingYu.xcodeproj/

    - name: Build for iOS Simulator (Free)
      run: |
        cd QingYu-iOS
        xcodebuild -project QingYu.xcworkspace \
                   -scheme QingYu \
                   -configuration Debug \
                   -destination 'platform=iOS Simulator,name=iPhone 15,OS=17.0' \
                   -derivedDataPath ./build \
                   build

    - name: Generate screenshots from simulator
      run: |
        # å¯åŠ¨æ¨¡æ‹Ÿå™¨å¹¶è¿è¡Œåº”ç”¨
        xcrun simctl boot "iPhone 15" || true

        # å®‰è£…åº”ç”¨åˆ°æ¨¡æ‹Ÿå™¨
        APP_PATH=$(find QingYu-iOS/build -name "*.app" | head -1)
        if [ -n "$APP_PATH" ]; then
          xcrun simctl install "iPhone 15" "$APP_PATH"

          # å¯åŠ¨åº”ç”¨
          BUNDLE_ID=$(plutil -p "$APP_PATH/Info.plist" | grep CFBundleIdentifier | cut -d\" -f4)
          xcrun simctl launch "iPhone 15" "$BUNDLE_ID"

          # ç­‰å¾…åº”ç”¨å¯åŠ¨
          sleep 5

          # æˆªå–å±å¹•æˆªå›¾
          xcrun simctl io "iPhone 15" screenshot app_screenshot.png

          echo "âœ… åº”ç”¨å·²åœ¨æ¨¡æ‹Ÿå™¨ä¸­å¯åŠ¨å¹¶æˆªå›¾"
        else
          echo "âš ï¸ æœªæ‰¾åˆ°åº”ç”¨æ–‡ä»¶ï¼Œåˆ›å»ºé¡¹ç›®ä¿¡æ¯æˆªå›¾"
          # åˆ›å»ºé¡¹ç›®ç»“æ„å›¾ç‰‡ä¿¡æ¯
          echo "QingYu iOS App - GitHub Actions Build" > project_info.txt
          echo "Build Date: $(date)" >> project_info.txt
          echo "Build Status: Success" >> project_info.txt
        fi

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ios-demo-files
        path: |
          app_screenshot.png
          project_info.txt
          QingYu-iOS/build/
        retention-days: 30

  # Webç‰ˆæœ¬æ„å»º - å¯åœ¨æ‰‹æœºæµè§ˆå™¨æµ‹è¯•
  build-web-demo:
    runs-on: macos-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Create Web Demo
      run: |
        mkdir -p web-demo

        # åˆ›å»ºWebç‰ˆæœ¬çš„ä¸»é¡µ
        cat > web-demo/index.html << 'EOF'
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>è½»è¯­ - å›½é£ç–—æ„ˆAppæ¼”ç¤º</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 414px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            box-shadow: 0 0 40px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 60px 20px 30px;
            text-align: center;
        }

        .app-title {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .app-subtitle {
            font-size: 16px;
            opacity: 0.9;
        }

        .search-container {
            margin: 20px;
            position: relative;
        }

        .search-box {
            width: 100%;
            padding: 16px 20px 16px 50px;
            border: none;
            border-radius: 25px;
            background: #f5f5f7;
            font-size: 16px;
            outline: none;
        }

        .search-icon {
            position: absolute;
            left: 18px;
            top: 50%;
            transform: translateY(-50%);
            color: #8e8e93;
        }

        .scenes {
            display: flex;
            padding: 0 20px;
            margin-bottom: 20px;
            gap: 12px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .scene-btn {
            flex-shrink: 0;
            padding: 12px 20px;
            border-radius: 20px;
            border: 2px solid #e0e0e0;
            background: white;
            color: #333;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .scene-btn.active {
            background: #007AFF;
            border-color: #007AFF;
            color: white;
        }

        .track-list {
            padding: 0 20px;
        }

        .track-item {
            display: flex;
            align-items: center;
            padding: 16px 0;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .track-item:hover {
            background: #f8f8fa;
            margin: 0 -20px;
            padding: 16px 20px;
        }

        .track-cover {
            width: 56px;
            height: 56px;
            border-radius: 12px;
            background: linear-gradient(45deg, #ddd 25%, #eee 50%, #ddd 75%);
            margin-right: 16px;
            position: relative;
            overflow: hidden;
        }

        .track-cover::before {
            content: "ğŸµ";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
        }

        .track-info {
            flex: 1;
        }

        .track-title {
            font-size: 16px;
            font-weight: 500;
            color: #333;
            margin-bottom: 4px;
        }

        .track-artist {
            font-size: 14px;
            color: #8e8e93;
        }

        .track-duration {
            font-size: 12px;
            color: #8e8e93;
        }

        .track-actions {
            display: flex;
            gap: 12px;
        }

        .action-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: none;
            background: #f0f0f0;
            color: #007AFF;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .action-btn:hover {
            background: #007AFF;
            color: white;
        }

        .player-overlay {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 414px;
            background: white;
            border-top: 1px solid #e0e0e0;
            padding: 20px;
            display: none;
        }

        .player-overlay.active {
            display: block;
        }

        .now-playing {
            text-align: center;
            margin-bottom: 20px;
        }

        .vinyl-record {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: linear-gradient(45deg, #222 25%, #333 50%, #222 75%);
            margin: 0 auto 20px;
            position: relative;
            animation: spin 3s linear infinite paused;
        }

        .vinyl-record.playing {
            animation-play-state: running;
        }

        .vinyl-record::before {
            content: "";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e74c3c;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            align-items: center;
        }

        .control-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            background: #007AFF;
            color: white;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .control-btn:hover {
            transform: scale(1.1);
        }

        .control-btn.play-btn {
            width: 60px;
            height: 60px;
            font-size: 24px;
        }

        .demo-badge {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #ff3b30;
            color: white;
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            z-index: 10;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="demo-badge">æ¼”ç¤ºç‰ˆæœ¬</div>

        <div class="header">
            <h1 class="app-title">è½»è¯­</h1>
            <p class="app-subtitle">å›½é£ç–—æ„ˆ Â· ç¢ç‰‡æ—¶å…‰</p>
        </div>

        <div class="search-container">
            <span class="search-icon">ğŸ”</span>
            <input type="text" class="search-box" placeholder="æœç´¢æ›²ç›®æˆ–è‰ºæœ¯å®¶">
        </div>

        <div class="scenes">
            <button class="scene-btn active" onclick="switchScene(this, 'zen')">ğŸ§˜ ç¦…æ„é™å¿ƒ</button>
            <button class="scene-btn" onclick="switchScene(this, 'relax')">â˜€ï¸ æ—¥å¸¸è§£å‹</button>
            <button class="scene-btn" onclick="switchScene(this, 'sleep')">ğŸŒ™ ç¡å‰åŠ©çœ </button>
            <button class="scene-btn" onclick="switchScene(this, 'relief')">ğŸ’— ç¼“è§£ç„¦è™‘</button>
        </div>

        <div class="track-list" id="trackList">
            <div class="track-item" onclick="playTrack('ç«¹æ—æ¸…é£')">
                <div class="track-cover"></div>
                <div class="track-info">
                    <div class="track-title">ç«¹æ—æ¸…é£</div>
                    <div class="track-artist">è½»è¯­</div>
                </div>
                <div class="track-duration">0:30</div>
                <div class="track-actions">
                    <button class="action-btn" onclick="toggleCache(this)">â¬‡ï¸</button>
                    <button class="action-btn" onclick="toggleFavorite(this)">ğŸ¤</button>
                </div>
            </div>

            <div class="track-item" onclick="playTrack('å±±æ¶§æºªæµ')">
                <div class="track-cover"></div>
                <div class="track-info">
                    <div class="track-title">å±±æ¶§æºªæµ</div>
                    <div class="track-artist">è½»è¯­</div>
                </div>
                <div class="track-duration">0:25</div>
                <div class="track-actions">
                    <button class="action-btn" onclick="toggleCache(this)">â¬‡ï¸</button>
                    <button class="action-btn" onclick="toggleFavorite(this)">ğŸ¤</button>
                </div>
            </div>

            <div class="track-item" onclick="playTrack('å¤ç´ç¦…éŸ³')">
                <div class="track-cover"></div>
                <div class="track-info">
                    <div class="track-title">å¤ç´ç¦…éŸ³</div>
                    <div class="track-artist">è½»è¯­</div>
                </div>
                <div class="track-duration">0:35</div>
                <div class="track-actions">
                    <button class="action-btn" onclick="toggleCache(this)">â¬‡ï¸</button>
                    <button class="action-btn" onclick="toggleFavorite(this)">ğŸ¤</button>
                </div>
            </div>
        </div>

        <div class="player-overlay" id="player">
            <div class="now-playing">
                <div class="vinyl-record" id="vinyl">
                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 20px;">ğŸµ</div>
                </div>
                <div style="font-weight: 500; margin-bottom: 4px;" id="nowPlayingTitle">ç«¹æ—æ¸…é£</div>
                <div style="font-size: 14px; color: #8e8e93;">è½»è¯­</div>
            </div>

            <div class="controls">
                <button class="control-btn" onclick="previousTrack()">â®ï¸</button>
                <button class="control-btn play-btn" onclick="togglePlay()" id="playBtn">â–¶ï¸</button>
                <button class="control-btn" onclick="nextTrack()">â­ï¸</button>
            </div>
        </div>
    </div>

    <script>
        let isPlaying = false;
        let currentTrack = 0;
        const tracks = ['ç«¹æ—æ¸…é£', 'å±±æ¶§æºªæµ', 'å¤ç´ç¦…éŸ³', 'æ™¨éœ²å¾®å…‰', 'æœˆå…‰æ‘‡ç¯®æ›²', 'æ±Ÿå—çƒŸé›¨'];

        function switchScene(btn, scene) {
            document.querySelectorAll('.scene-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            // æ¨¡æ‹Ÿä¸åŒåœºæ™¯çš„æ›²ç›®
            updateTrackList(scene);
        }

        function updateTrackList(scene) {
            const trackList = document.getElementById('trackList');
            const sceneTracks = {
                'zen': ['ç«¹æ—æ¸…é£', 'å¤ç´ç¦…éŸ³', 'å±±æ¶§æºªæµ'],
                'relax': ['æ™¨éœ²å¾®å…‰', 'é¸Ÿè¯­èŠ±é¦™', 'å’Œé£ç»†é›¨'],
                'sleep': ['æœˆå…‰æ‘‡ç¯®æ›²', 'å¤œç©ºæ˜Ÿè¾°', 'å®é™æ¹–æ³Š'],
                'relief': ['æ±Ÿå—çƒŸé›¨', 'å¿ƒçµæ¸©æ³‰', 'å¹³å’Œä¹‹å¢ƒ']
            };

            trackList.innerHTML = sceneTracks[scene].map((track, index) => `
                <div class="track-item" onclick="playTrack('${track}')">
                    <div class="track-cover"></div>
                    <div class="track-info">
                        <div class="track-title">${track}</div>
                        <div class="track-artist">è½»è¯­</div>
                    </div>
                    <div class="track-duration">0:${20 + index * 5}</div>
                    <div class="track-actions">
                        <button class="action-btn" onclick="toggleCache(this)">â¬‡ï¸</button>
                        <button class="action-btn" onclick="toggleFavorite(this)">ğŸ¤</button>
                    </div>
                </div>
            `).join('');
        }

        function playTrack(title) {
            document.getElementById('nowPlayingTitle').textContent = title;
            document.getElementById('player').classList.add('active');

            // æ·»åŠ è§¦è§‰åé¦ˆæ¨¡æ‹Ÿï¼ˆæŒ¯åŠ¨ï¼‰
            if (navigator.vibrate) {
                navigator.vibrate(50);
            }
        }

        function togglePlay() {
            isPlaying = !isPlaying;
            const btn = document.getElementById('playBtn');
            const vinyl = document.getElementById('vinyl');

            btn.textContent = isPlaying ? 'â¸ï¸' : 'â–¶ï¸';
            vinyl.classList.toggle('playing', isPlaying);

            if (navigator.vibrate) {
                navigator.vibrate(30);
            }
        }

        function toggleCache(btn) {
            btn.textContent = btn.textContent === 'â¬‡ï¸' ? 'âœ…' : 'â¬‡ï¸';
            if (navigator.vibrate) {
                navigator.vibrate(20);
            }
        }

        function toggleFavorite(btn) {
            btn.textContent = btn.textContent === 'ğŸ¤' ? 'â¤ï¸' : 'ğŸ¤';
            if (navigator.vibrate) {
                navigator.vibrate(20);
            }
        }

        function previousTrack() {
            currentTrack = (currentTrack - 1 + tracks.length) % tracks.length;
            playTrack(tracks[currentTrack]);
        }

        function nextTrack() {
            currentTrack = (currentTrack + 1) % tracks.length;
            playTrack(tracks[currentTrack]);
        }

        // æ·»åŠ é¡µé¢å¯è§æ€§æ£€æµ‹ï¼Œä¼˜åŒ–ä½“éªŒ
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                // é¡µé¢éšè—æ—¶æš‚åœ
                isPlaying = false;
                document.getElementById('playBtn').textContent = 'â–¶ï¸';
                document.getElementById('vinyl').classList.remove('playing');
            }
        });
    </script>
</body>
</html>
EOF

        echo "âœ… Webæ¼”ç¤ºé¡µé¢åˆ›å»ºå®Œæˆ"

    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      if: github.ref == 'refs/heads/main'
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./web-demo
        destination_dir: demo

    - name: Build Summary
      run: |
        echo "## ğŸ‰ æ„å»ºå®Œæˆ!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âœ… å®Œæˆçš„ä»»åŠ¡:" >> $GITHUB_STEP_SUMMARY
        echo "- [x] iOSæ¨¡æ‹Ÿå™¨æ„å»ºæˆåŠŸ" >> $GITHUB_STEP_SUMMARY
        echo "- [x] Webæ¼”ç¤ºé¡µé¢éƒ¨ç½²å®Œæˆ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸŒ Webæ¼”ç¤ºåœ°å€:" >> $GITHUB_STEP_SUMMARY
        echo "https://${{ github.repository_owner }}.github.io/QingYu-iOS/demo/" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“± å¦‚ä½•ä½“éªŒ:" >> $GITHUB_STEP_SUMMARY
        echo "1. **Webç‰ˆæœ¬**: åœ¨iPhoneæµè§ˆå™¨ä¸­æ‰“å¼€ä¸Šé¢çš„é“¾æ¥" >> $GITHUB_STEP_SUMMARY
        echo "2. **å®Œæ•´åŠŸèƒ½**: å¯ä»¥ä½“éªŒç•Œé¢å’ŒåŸºæœ¬äº¤äº’" >> $GITHUB_STEP_SUMMARY
        echo "3. **æ— éœ€å®‰è£…**: ç›´æ¥åœ¨æµè§ˆå™¨ä¸­ä½¿ç”¨" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ”§ æŸ¥çœ‹æ„å»ºæ–‡ä»¶:" >> $GITHUB_STEP_SUMMARY
        echo "- ä¸‹è½½ Artifacts æŸ¥çœ‹æ„å»ºæ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
        echo "- åŒ…å«æ¨¡æ‹Ÿå™¨æˆªå›¾å’Œé¡¹ç›®ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY

  # é¡¹ç›®ä¿¡æ¯å±•ç¤º
  project-info:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Generate project README
      run: |
        cat > PROJECT_DEMO.md << 'EOF'
# ğŸµ è½»è¯­ - å›½é£ç–—æ„ˆAPPæ¼”ç¤º

## âœ¨ å½“å‰çŠ¶æ€
- ğŸ“± **Webæ¼”ç¤ºç‰ˆæœ¬**: å¯ç›´æ¥åœ¨iPhoneæµè§ˆå™¨ä¸­ä½“éªŒ
- ğŸ”§ **iOSæ„å»º**: æ¨¡æ‹Ÿå™¨æ„å»ºæˆåŠŸ
- ğŸ“ **ä»£ç å®Œæ•´**: åŒ…å«æ‰€æœ‰Swiftæºç æ–‡ä»¶

## ğŸŒ åœ¨çº¿æ¼”ç¤º
ç‚¹å‡»ä¸‹é¢çš„é“¾æ¥ç›´æ¥ä½“éªŒï¼š
**[è½»è¯­APPæ¼”ç¤º](https://${{ github.repository_owner }}.github.io/QingYu-iOS/demo/)**

### ğŸ“± åŠŸèƒ½æ¼”ç¤º
- âœ¨ å›½é£ç•Œé¢è®¾è®¡
- ğŸµ é»‘èƒ¶å”±ç‰‡äº¤äº’æ•ˆæœ
- ğŸ”„ åœºæ™¯åˆ‡æ¢ï¼ˆç¦…æ„/è§£å‹/åŠ©çœ /ç„¦è™‘ï¼‰
- ğŸ’¾ æ”¶è—å’Œç¼“å­˜åŠŸèƒ½
- ğŸ§ æ’­æ”¾æ§åˆ¶ç•Œé¢
- ğŸŒ å¤šè¯­è¨€æ”¯æŒå‡†å¤‡

## ğŸ“‹ é¡¹ç›®ç»“æ„
\`\`\`
QingYu-iOS/
â”œâ”€â”€ App/                     # åº”ç”¨æ ¸å¿ƒ
â”‚   â”œâ”€â”€ AppDelegate.swift    # åº”ç”¨å§”æ‰˜
â”‚   â””â”€â”€ SceneDelegate.swift  # åœºæ™¯å§”æ‰˜
â”œâ”€â”€ Views/                   # è§†å›¾æ§åˆ¶å™¨
â”‚   â”œâ”€â”€ HomeViewController.swift
â”‚   â”œâ”€â”€ PlayerViewController.swift
â”‚   â”œâ”€â”€ ProfileViewController.swift
â”‚   â””â”€â”€ VinylRecordView.swift
â”œâ”€â”€ Managers/                # ç®¡ç†å™¨
â”‚   â”œâ”€â”€ AudioPlayerManager.swift
â”‚   â””â”€â”€ APIManager.swift
â”œâ”€â”€ Resources/               # èµ„æºæ–‡ä»¶
â””â”€â”€ QingYu.xcodeproj/        # Xcodeé¡¹ç›®
\`\`\`

## ğŸš€ ä¸‹ä¸€æ­¥è®¡åˆ’
1. é…ç½®Apple Developerè´¦å·
2. è®¾ç½®å¼€å‘è€…è¯ä¹¦
3. æ„å»ºçœŸæœºå®‰è£…åŒ…
4. App Storeå‘å¸ƒ

## ğŸ“ è”ç³»æ–¹å¼
å¦‚éœ€æŠ€æœ¯æ”¯æŒæˆ–å•†ä¸šåˆä½œï¼Œè¯·è”ç³»å¼€å‘å›¢é˜Ÿã€‚

---
*æ¼”ç¤ºç‰ˆæœ¬ - 2025å¹´11æœˆ*
EOF

    - name: Upload project info
      uses: actions/upload-artifact@v4
      with:
        name: project-info
        path: PROJECT_DEMO.md