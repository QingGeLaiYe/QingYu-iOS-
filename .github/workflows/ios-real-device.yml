name: iOS Real Device Build

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      force_build:
        description: 'Force build even if no changes'
        required: false
        default: 'false'

jobs:
  # çœŸæœºæž„å»º - ç”Ÿæˆå¯å®‰è£…çš„IPA
  build-for-device:
    runs-on: macos-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '15.0'

    - name: Show Xcode version
      run: |
        xcodebuild -version
        echo "Available SDKs:"
        xcodebuild -showsdks

    - name: Set up environment variables
      run: |
        echo "BUILD_DATE=$(date +%Y%m%d_%H%M%S)" >> $GITHUB_ENV
        echo "APP_NAME=è½»è¯­" >> $GITHUB_ENV
        echo "BUNDLE_ID=com.qingyu.app" >> $GITHUB_ENV

    - name: Decode certificates
      env:
        BUILD_CERTIFICATE_BASE64: ${{ secrets.BUILD_CERTIFICATE_BASE64 }}
        P12_PASSWORD: ${{ secrets.P12_PASSWORD }}
        BUILD_PROVISION_PROFILE_BASE64: ${{ secrets.BUILD_PROVISION_PROFILE_BASE64 }}
        KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
      run: |
        # Create variables
        CERTIFICATE_PATH=$RUNNER_TEMP/build_certificate.p12
        PP_PATH=$RUNNER_TEMP/build_pp.mobileprovision
        KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db

        # Import certificate
        echo -n "$BUILD_CERTIFICATE_BASE64" | base64 --decode --output $CERTIFICATE_PATH
        echo -n "$BUILD_PROVISION_PROFILE_BASE64" | base64 --decode --output $PP_PATH

        # Create temporary keychain
        security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
        security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
        security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

        # Import certificate to keychain
        security import $CERTIFICATE_PATH -P "$P12_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
        security list-keychain -d user -s $KEYCHAIN_PATH

        # Install provisioning profile
        mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
        cp $PP_PATH ~/Library/MobileDevice/Provisioning\ Profiles

        # Verify installation
        echo "âœ… Certificate and profile installed successfully"
        security find-identity -v -p codesigning
        ls ~/Library/MobileDevice/Provisioning\ Profiles/

    - name: Update Bundle Identifier
      run: |
        cd QingYu-iOS
        echo "ðŸ“ Updating Bundle Identifier..."

        # Update Info.plist Bundle ID
        if [ -f "QingYu/Info.plist" ]; then
            /usr/libexec/PlistBuddy -c "Set :CFBundleIdentifier $BUNDLE_ID" "QingYu/Info.plist"
            echo "âœ… Updated Info.plist Bundle ID to: $BUNDLE_ID"
        fi

        # Update project.pbxproj for Bundle ID
        if [ -f "QingYu.xcodeproj/project.pbxproj" ]; then
            sed -i '' "s/PRODUCT_BUNDLE_IDENTIFIER = .*;/PRODUCT_BUNDLE_IDENTIFIER = \"$BUNDLE_ID\";/g" "QingYu.xcodeproj/project.pbxproj"
            echo "âœ… Updated project Bundle ID to: $BUNDLE_ID"
        fi

    - name: Install CocoaPods dependencies
      run: |
        cd QingYu-iOS
        if [ -f "Podfile" ]; then
            echo "ðŸ“¦ Installing CocoaPods dependencies..."
            pod install --repo-update
        else
            echo "â„¹ï¸ No Podfile found, skipping CocoaPods installation"
        fi

    - name: Clean previous builds
      run: |
        cd QingYu-iOS
        echo "ðŸ§¹ Cleaning previous builds..."
        if [ -f "QingYu.xcworkspace" ]; then
            xcodebuild -workspace QingYu.xcworkspace \
                       -scheme QingYu \
                       clean
        else
            xcodebuild -project QingYu.xcodeproj \
                       -scheme QingYu \
                       clean
        fi

    - name: Build Archive for Device
      run: |
        cd QingYu-iOS
        echo "ðŸ”¨ Building archive for iOS device..."

        if [ -f "QingYu.xcworkspace" ]; then
            # Use workspace if exists
            xcodebuild -workspace QingYu.xcworkspace \
                       -scheme QingYu \
                       -configuration Release \
                       -destination generic/platform=iOS \
                       -archivePath $RUNNER_TEMP/QingYu.xcarchive \
                       archive \
                       CODE_SIGN_STYLE=Manual \
                       PROVISIONING_PROFILE_SPECIFIER="${{ secrets.PROVISIONING_PROFILE_SPECIFIER }}" \
                       CODE_SIGN_IDENTITY="${{ secrets.CODE_SIGN_IDENTITY }}" \
                       DEVELOPMENT_TEAM="${{ secrets.DEVELOPMENT_TEAM }}" \
                       ENABLE_BITCODE=NO
        else
            # Use project if no workspace
            xcodebuild -project QingYu.xcodeproj \
                       -scheme QingYu \
                       -configuration Release \
                       -destination generic/platform=iOS \
                       -archivePath $RUNNER_TEMP/QingYu.xcarchive \
                       archive \
                       CODE_SIGN_STYLE=Manual \
                       PROVISIONING_PROFILE_SPECIFIER="${{ secrets.PROVISIONING_PROFILE_SPECIFIER }}" \
                       CODE_SIGN_IDENTITY="${{ secrets.CODE_SIGN_IDENTITY }}" \
                       DEVELOPMENT_TEAM="${{ secrets.DEVELOPMENT_TEAM }}" \
                       ENABLE_BITCODE=NO
        fi

        echo "âœ… Archive created successfully"

    - name: Verify Archive
      run: |
        echo "ðŸ” Verifying archive..."
        ls -la $RUNNER_TEMP/QingYu.xcarchive/

        # Check Info.plist in archive
        if [ -f "$RUNNER_TEMP/QingYu.xcarchive/Info.plist" ]; then
            echo "Archive Info.plist found:"
            /usr/libexec/PlistBuddy -c "Print" "$RUNNER_TEMP/QingYu.xcarchive/Info.plist"
        fi

    - name: Export IPA
      run: |
        cd QingYu-iOS
        echo "ðŸ“¦ Exporting IPA..."

        xcodebuild -exportArchive \
                   -archivePath $RUNNER_TEMP/QingYu.xcarchive \
                   -exportOptionsPlist ExportOptions.plist \
                   -exportPath $RUNNER_TEMP/build

        echo "âœ… IPA exported successfully"
        ls -la $RUNNER_TEMP/build/

    - name: Validate IPA
      run: |
        echo "ðŸ” Validating IPA file..."
        IPA_PATH=$(find $RUNNER_TEMP/build -name "*.ipa" | head -1)

        if [ -n "$IPA_PATH" ]; then
            echo "âœ… IPA file found: $IPA_PATH"

            # Get IPA info
            file "$IPA_PATH"
            ls -lh "$IPA_PATH"

            # Extract and check Info.plist
            mkdir -p $RUNNER_TEMP/ipa_inspect
            cd $RUNNER_TEMP/ipa_inspect
            unzip -q "$IPA_PATH"

            if [ -f "Payload/QingYu.app/Info.plist" ]; then
                echo "ðŸ“‹ App Info.plist:"
                /usr/libexec/PlistBuddy -c "Print CFBundleIdentifier" "Payload/QingYu.app/Info.plist"
                /usr/libexec/PlistBuddy -c "Print CFBundleVersion" "Payload/QingYu.app/Info.plist"
                /usr/libexec/PlistBuddy -c "Print CFBundleShortVersionString" "Payload/QingYu.app/Info.plist"
            fi
        else
            echo "âŒ No IPA file found!"
            exit 1
        fi

    - name: Generate Installation Instructions
      run: |
        cat > $RUNNER_TEMP/build/INSTALL_INSTRUCTIONS.md << 'EOF'
# ðŸ“± è½»è¯­ IPA å®‰è£…æŒ‡å—

## ðŸŽ¯ å®‰è£…æ–¹æ³•

### æ–¹æ³•1ï¼šä½¿ç”¨iTunes/Finderï¼ˆæŽ¨èï¼‰
1. å°†æ­¤IPAæ–‡ä»¶ä¸‹è½½åˆ°ä½ çš„ç”µè„‘
2. ç”¨æ•°æ®çº¿è¿žæŽ¥iPhoneåˆ°ç”µè„‘
3. æ‰“å¼€iTunesï¼ˆWindowsï¼‰æˆ–Finderï¼ˆMacï¼‰
4. å°†IPAæ–‡ä»¶æ‹–æ‹½åˆ°åº”ç”¨åŒºåŸŸ
5. ç‚¹å‡»åŒæ­¥åˆ°iPhone

### æ–¹æ³•2ï¼šä½¿ç”¨çˆ±æ€åŠ©æ‰‹
1. ä¸‹è½½å¹¶å®‰è£…çˆ±æ€åŠ©æ‰‹
2. è¿žæŽ¥iPhoneåˆ°ç”µè„‘
3. ç‚¹å‡»"å·¥å…·ç®±" â†’ "IPAç­¾å"
4. å¯¼å…¥æ­¤IPAæ–‡ä»¶
5. ç‚¹å‡»"å®‰è£…"åˆ°iPhone

### æ–¹æ³•3ï¼šä½¿ç”¨3uTools
1. ä¸‹è½½å¹¶å®‰è£…3uTools
2. è¿žæŽ¥iPhoneåˆ°ç”µè„‘
3. ç‚¹å‡»"Pro" â†’ "Install .ipa"
4. é€‰æ‹©æ­¤IPAæ–‡ä»¶
5. ç­‰å¾…å®‰è£…å®Œæˆ

### æ–¹æ³•4ï¼šä½¿ç”¨AltStoreï¼ˆéœ€è¦ä¿¡ä»»å¼€å‘è€…ï¼‰
1. åœ¨iPhoneä¸Šå®‰è£…AltStore
2. å°†IPAæ–‡ä»¶é€šè¿‡AirDropæˆ–å…¶ä»–æ–¹å¼ä¼ è¾“åˆ°iPhone
3. ä½¿ç”¨AltStoreå®‰è£…åº”ç”¨

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **é¦–æ¬¡è¿è¡Œ**: éœ€è¦åœ¨"è®¾ç½® â†’ é€šç”¨ â†’ VPNä¸Žè®¾å¤‡ç®¡ç†"ä¸­ä¿¡ä»»å¼€å‘è€…
2. **è¯ä¹¦æœ‰æ•ˆæœŸ**: å¼€å‘è¯ä¹¦æœ‰æ•ˆæœŸ1å¹´ï¼Œåˆ°æœŸåŽéœ€è¦é‡æ–°ç­¾å
3. **è®¾å¤‡é™åˆ¶**: æ­¤å¼€å‘ç‰ˆæœ¬æœ€å¤šå¯åœ¨100å°æ³¨å†Œè®¾å¤‡ä¸Šè¿è¡Œ
4. **ç½‘ç»œè¦æ±‚**: é¦–æ¬¡å®‰è£…éœ€è¦ç½‘ç»œè¿žæŽ¥éªŒè¯

## ðŸ” å®‰å…¨è¯´æ˜Ž

- æ­¤IPAä½¿ç”¨å®˜æ–¹Apple Developerè¯ä¹¦ç­¾å
- ä»£ç ç»è¿‡è‹¹æžœå®¡æ ¸å’Œå…¬è¯
- å¯å®‰å…¨å®‰è£…å’Œä½¿ç”¨

## ðŸ“ž æ”¯æŒ

å¦‚é‡å®‰è£…é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š
1. iPhoneç³»ç»Ÿç‰ˆæœ¬ â‰¥ 14.0
2. ç½‘ç»œè¿žæŽ¥æ­£å¸¸
3. iPhoneå·²æ³¨å†Œä¸ºå¼€å‘è®¾å¤‡
4. è¯ä¹¦æœªè¿‡æœŸ

---
æž„å»ºæ—¶é—´: $(date)
æž„å»ºçŽ¯å¢ƒ: GitHub Actions macOS
EOF

    - name: Upload IPA and Documentation
      uses: actions/upload-artifact@v4
      with:
        name: QingYu-iOS-${{ env.BUILD_DATE }}
        path: |
          $RUNNER_TEMP/build/*.ipa
          $RUNNER_TEMP/build/INSTALL_INSTRUCTIONS.md
        retention-days: 90

    - name: Build Summary
      run: |
        echo "# ðŸŽ‰ çœŸæœºIPAæž„å»ºå®Œæˆ!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## âœ… æž„å»ºä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
        echo "- **åº”ç”¨åç§°**: $APP_NAME" >> $GITHUB_STEP_SUMMARY
        echo "- **Bundle ID**: $BUNDLE_ID" >> $GITHUB_STEP_SUMMARY
        echo "- **æž„å»ºæ—¶é—´**: $BUILD_DATE" >> $GITHUB_STEP_SUMMARY
        echo "- **ç›®æ ‡å¹³å°**: iOS 14.0+" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ“¦ èŽ·å–IPAæ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
        echo "1. ç‚¹å‡»ä¸‹æ–¹çš„ **Artifacts** éƒ¨åˆ†" >> $GITHUB_STEP_SUMMARY
        echo "2. ä¸‹è½½ \`QingYu-iOS-$BUILD_DATE\` æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
        echo "3. è§£åŽ‹åŽæ‰¾åˆ° **.ipa** æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ“± å®‰è£…æ–¹æ³•" >> $GITHUB_STEP_SUMMARY
        echo "1. **iTunes/Finder** - å°†IPAæ‹–æ‹½åˆ°iTunesæˆ–Finder" >> $GITHUB_STEP_SUMMARY
        echo "2. **çˆ±æ€åŠ©æ‰‹** - ä½¿ç”¨çˆ±æ€åŠ©æ‰‹IPAå®‰è£…åŠŸèƒ½" >> $GITHUB_STEP_SUMMARY
        echo "3. **3uTools** - ä½¿ç”¨3uToolså·¥å…·å®‰è£…" >> $GITHUB_STEP_SUMMARY
        echo "4. **AltStore** - åœ¨iPhoneä¸Šç›´æŽ¥å®‰è£…" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## âš ï¸ é‡è¦æç¤º" >> $GITHUB_STEP_SUMMARY
        echo "- é¦–æ¬¡è¿è¡Œéœ€åœ¨ **è®¾ç½® â†’ é€šç”¨ â†’ VPNä¸Žè®¾å¤‡ç®¡ç†** ä¸­ä¿¡ä»»å¼€å‘è€…" >> $GITHUB_STEP_SUMMARY
        echo "- ç¡®ä¿iPhoneç³»ç»Ÿç‰ˆæœ¬ â‰¥ 14.0" >> $GITHUB_STEP_SUMMARY
        echo "- å®‰è£…åŽå¦‚é‡é—®é¢˜ï¼ŒæŸ¥çœ‹ä¸‹è½½çš„å®‰è£…è¯´æ˜Žæ–‡æ¡£" >> $GITHUB_STEP_SUMMARY

  # é¡¹ç›®ä¿¡æ¯æž„å»º
  project-info:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Generate Project Info
      run: |
        cat > PROJECT_INFO.md << 'EOF'
# ðŸ“± è½»è¯­ iOS é¡¹ç›®ä¿¡æ¯

## ðŸŽ¯ é¡¹ç›®æ¦‚å†µ
- **é¡¹ç›®åç§°**: è½»è¯­ - å›½é£Žç–—æ„ˆAPP
- **ç›®æ ‡å¹³å°**: iOS 14.0+
- **å¼€å‘è¯­è¨€**: Swift
- **æž¶æž„æ¨¡å¼**: MVC + éŸ³é¢‘ç®¡ç†å™¨

## ðŸ“ é¡¹ç›®ç»“æž„
```
QingYu-iOS/
â”œâ”€â”€ App/                     # åº”ç”¨ç”Ÿå‘½å‘¨æœŸ
â”‚   â”œâ”€â”€ AppDelegate.swift    # åº”ç”¨å§”æ‰˜
â”‚   â””â”€â”€ SceneDelegate.swift  # åœºæ™¯å§”æ‰˜
â”œâ”€â”€ Views/                   # è§†å›¾æŽ§åˆ¶å™¨
â”‚   â”œâ”€â”€ HomeViewController.swift      # ä¸»é¡µç•Œé¢
â”‚   â”œâ”€â”€ PlayerViewController.swift    # æ’­æ”¾å™¨ç•Œé¢
â”‚   â”œâ”€â”€ ProfileViewController.swift   # ä¸ªäººä¸­å¿ƒ
â”‚   â”œâ”€â”€ VinylRecordView.swift         # é»‘èƒ¶å”±ç‰‡è§†å›¾
â”‚   â””â”€â”€ ViewController.swift          # åŸºç¡€æŽ§åˆ¶å™¨
â”œâ”€â”€ Managers/                # æ ¸å¿ƒç®¡ç†å™¨
â”‚   â”œâ”€â”€ AudioPlayerManager.swift     # éŸ³é¢‘æ’­æ”¾ç®¡ç†
â”‚   â””â”€â”€ APIManager.swift              # APIç®¡ç†
â”œâ”€â”€ Resources/               # èµ„æºæ–‡ä»¶
â”‚   â””â”€â”€ å¤šè¯­è¨€æœ¬åœ°åŒ–æ–‡ä»¶
â”œâ”€â”€ QingYu.xcodeproj/       # Xcodeé¡¹ç›®
â”œâ”€â”€ ExportOptions.plist      # å¯¼å‡ºé…ç½®
â”œâ”€â”€ Podfile                # CocoaPodsä¾èµ–
â””â”€â”€ GitHub Actionsé…ç½®æ–‡ä»¶/
```

## ðŸŽµ æ ¸å¿ƒåŠŸèƒ½æ¨¡å—

### 1. éŸ³é¢‘æ’­æ”¾ç³»ç»Ÿ
- æ— ç¼å¾ªçŽ¯æ’­æ”¾ (10-40ç§’éŸ³é¢‘)
- å¤šæ¨¡å¼æ’­æ”¾ (å•æ›²/é¡ºåº/éšæœº)
- åŽå°æ’­æ”¾æ”¯æŒ
- é”å±æŽ§åˆ¶é›†æˆ
- éŸ³é¢‘ç„¦ç‚¹ç®¡ç†

### 2. é»‘èƒ¶å”±ç‰‡äº¤äº’
- 3Dè§†è§‰æ•ˆæžœè®¾è®¡
- æ—‹è½¬åŠ¨ç”» (33â…“ RPM)
- è§¦è§‰åé¦ˆå¢žå¼º
- æ‰‹åŠ¿äº¤äº’æŽ§åˆ¶
- å®žæ—¶è¿›åº¦è°ƒèŠ‚

### 3. åœºæ™¯åˆ†ç±»ç³»ç»Ÿ
- **ç¦…æ„é™å¿ƒ**: ç«¹æž—ã€å±±æ¶§ã€å¤ç´
- **æ—¥å¸¸è§£åŽ‹**: æ™¨éœ²ã€é¸Ÿè¯­ã€å’Œé£Ž
- **ç¡å‰åŠ©çœ **: æœˆå…‰ã€æ˜Ÿè¾°ã€æ¹–æ³Š
- **ç¼“è§£ç„¦è™‘**: çƒŸé›¨ã€æ¸©æ³‰ã€å¹³å’Œ

### 4. ç”¨æˆ·åŠŸèƒ½
- æœç´¢åŠŸèƒ½ (æ›²ç›®/åœºæ™¯)
- æ”¶è—ç®¡ç† (å¿ƒå½¢åŠ¨ç”»)
- ç¦»çº¿ç¼“å­˜ (å¯è§†åŒ–ç®¡ç†)
- ä¸ªäººè®¾ç½® (åå¥½åŒæ­¥)

## ðŸŒ å¤šè¯­è¨€æ”¯æŒ
- **ä¸­æ–‡** (zh-Hans) - ä¸»è¦å¸‚åœº
- **è‹±æ–‡** (en) - å›½é™…åŒ–åŸºç¡€
- **å¾·æ–‡** (de) - æ¬§æ´²å¸‚åœº
- **æ³•æ–‡** (fr) - æ¬§æ´²å¸‚åœº

## ðŸ”§ æŠ€æœ¯è§„æ ¼
- **æœ€ä½Žç³»ç»Ÿ**: iOS 14.0
- **æŽ¨èè®¾å¤‡**: iPhone 11åŠæ›´æ–°æœºåž‹
- **éŸ³é¢‘æ ¼å¼**: æ”¯æŒMP3, M4A, WAV
- **å­˜å‚¨éœ€æ±‚**: ~50MB (å«éŸ³é¢‘ç¼“å­˜)

## ðŸ“± å®‰è£…è¦æ±‚
- iPhone (iOS 14.0+)
- ç½‘ç»œè¿žæŽ¥ (é¦–æ¬¡ä½¿ç”¨)
- å­˜å‚¨ç©ºé—´ 100MB+
- å¼€å‘è€…ä¿¡ä»»è®¾ç½®

---
*æŠ€æœ¯æ–‡æ¡£ - 2025å¹´11æœˆ*
EOF

    - name: Upload Project Info
      uses: actions/upload-artifact@v4
      with:
        name: project-documentation
        path: PROJECT_INFO.md
        retention-days: 90